<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="icon" href="/favicon.ico">
    <script src="util/jquery@3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="util/bootstrap@3.3.7/css/bootstrap.min.css">
    <script src="util/bootstrap@3.3.7/js/bootstrap.min.js"></script>
    <script src="util/blueimp-md5@2.10.0/md5.min.js"></script>
    <title>简易密码管理器</title>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-8 col-md-offset-2">
                <div class="page-header">
                    <h1>简易密码管理器</h1>
                </div>
                <form class="form-horizontal">
                    <div class="form-group">
                        <label for="usage" class="col-sm-2 control-label">用途</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="usage" required="required" autofocus>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="pass" class="col-sm-2 control-label">主密码</label>
                        <div class="col-sm-10">
                            <input type="password" class="form-control" id="pass" required="required">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="digit" class="col-sm-2 control-label">位数</label>
                        <div class="col-sm-10">
                            <input type="number" class="form-control" id="digit" value="16" min="6" max="32" required="required">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="legacy" class="col-sm-2 control-label">兼容模式</label>
                        <div class="col-sm-10">
                            <input type="checkbox" id="legacy">&nbsp;&nbsp;
                            <span class="glyphicon glyphicon-question-sign" data-toggle="tooltip" data-placement="top" title="适配那些不支持特殊字符的远古网站"></span>&nbsp;&nbsp;
                            <div id="legacy-detail-wrapper" hidden>
                                <input type="checkbox" checked disabled>生成数字&nbsp;&nbsp;
                                <input type="checkbox" checked disabled>生成小写字母&nbsp;&nbsp;
                                <input type="checkbox" id="legacy-detail-case" checked>生成大写字母&nbsp;&nbsp;
                                <input type="checkbox" id="legacy-detail-underline" checked>生成下划线（_）&nbsp;&nbsp;
                                <input type="checkbox" id="legacy-detail-hyphen" checked>生成连字符（-）
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-10">
                            <input type="button" class="btn btn-primary" id="genAndCopy" value="生成并复制">
                            <input type="button" class="btn btn-default" id="gen" value="仅生成">
                        </div>
                    </div>
                    <div class="form-group" hidden="hidden" id="resultDiv">
                        <label for="res" class="col-sm-2 control-label">你的密码</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="res" readonly="readonly" aria-describedby="message">
                            <span id="message" class="help-block"></span>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <br><br><br><br><br>

    <footer class="navbar-fixed-bottom" style="background-color:lightgrey">
        <br>
        <div class="container">
            <div class="pull-left">
                <a class="text-muted" href="https://github.com/OrdosX/SimplePwdMgr">Github仓库</a>
            </div>
            <div class="pull-right">
                <span class="text-muted">由<a class="text-muted" href="https://www.ordosx.tech">OrdosX</a>用</span><span class="glyphicon glyphicon-heart"></span><span class="text-muted">打造</span>
            </div>
        </div>
        <br>
    </footer>

    <script>
        $(function () { $("[data-toggle='tooltip']").tooltip(); });
        
        function genNormal(usage, pass, digit) {
            var hash = md5(usage + ":" + pass).substr(0,digit);

            //计算字母和数字
            var alphabet = 0, number = 0;
            for (let i = 0; i < hash.length; i++) {
                if (hash.charCodeAt(i) >= 97 && hash.charCodeAt(i) <= 122) {
                    alphabet += 1;
                } else {
                    number += 1;
                }
            }

            //将字母和数字中的较小者调整为不小于较大者
            var splited = hash.split("");
            for (let i = 0; alphabet > number; i++) {
                if (hash.charCodeAt(i) >= 97 && hash.charCodeAt(i) <= 122) {
                    splited[i] = "8";
                    alphabet--;
                    number++;
                }
            }
            for (let i = 0; alphabet < number; i++) {
                if (hash.charCodeAt(i) >= 48 && hash.charCodeAt(i) <= 57) {
                    splited[i] = "x";
                    alphabet++;
                    number--;
                }
            }

            //将字母调整为一个大写一个小写，数字转换为一个数字一个符号
            var alphabetChanged = false, numberChanged = false;
            for (let i = 0; i < hash.length; i++) {
                if (splited[i].charCodeAt(0) >= 97 && splited[i].charCodeAt(0) <= 122) {
                    if (alphabetChanged) {
                        alphabetChanged = false;
                    } else {
                        splited[i] = splited[i].toUpperCase();
                        alphabetChanged = true;
                    }
                } else {
                    if (numberChanged) {
                        numberChanged = false;
                    } else {
                        splited[i] = String.fromCharCode(hash.charCodeAt(i)-10);
                        numberChanged = true;
                    }
                }
            }

            return splited.join("");
        }
        function genLegacy(usage, pass, digit, mode) {
            var hash = md5(usage + ":" + pass).substr(0,digit);

            //计算字母和数字
            var alphabet = 0, number = 0;
            for (let i = 0; i < hash.length; i++) {
                if (hash.charCodeAt(i) >= 97 && hash.charCodeAt(i) <= 122) {
                    alphabet += 1;
                } else {
                    number += 1;
                }
            }

            //将字母和数字中的较小者调整为不小于较大者
            var splited = hash.split("");
            for (let i = 0; alphabet > number; i++) {
                if (hash.charCodeAt(i) >= 97 && hash.charCodeAt(i) <= 122) {
                    splited[i] = "8";
                    alphabet--;
                    number++;
                }
            }
            for (let i = 0; alphabet < number; i++) {
                if (hash.charCodeAt(i) >= 48 && hash.charCodeAt(i) <= 57) {
                    splited[i] = "x";
                    alphabet++;
                    number--;
                }
            }

            //将字母调整为一个大写一个小写，数字转换为一个数字一个符号
            var alphabetChanged = false, numberChanged = false, hyphenUsed = false;
            for (let i = 0; i < hash.length; i++) {
                if (splited[i].charCodeAt(0) >= 97 && splited[i].charCodeAt(0) <= 122) {
                    if (alphabetChanged) {
                        alphabetChanged = false;
                    } else {
                        splited[i] = splited[i].toUpperCase();
                        alphabetChanged = true;
                    }
                } else {
                    if (numberChanged) {
                        numberChanged = false;
                    } else {
                        switch(mode) {
                            case 1: splited[i] = "_"; break;
                            case 2: splited[i] = "-"; break;
                            case 3: 
                                if(hyphenUsed) {
                                    splited[i] = "_";
                                    hyphenUsed = false;
                                    break;
                                } else {
                                    splited[i] = "-";
                                    hyphenUsed = true;
                                    break;
                                }
                        }
                        numberChanged = true;
                    }
                }
            }
            var result = splited.join("");
            if(!($("#legacy-detail-case").prop("checked"))) result = result.toLowerCase();
            return result;
        }
        function gen() {
            if ($("#legacy").prop("checked")) {
                var mode = 0;
                if($("#legacy-detail-underline").prop("checked") && $("#legacy-detail-hyphen").prop("checked")){
                    mode = 3;
                } else {
                    if($("#legacy-detail-underline").prop("checked")) mode = 1;
                    else if($("#legacy-detail-hyphen").prop("checked")) mode = 2;
                }
                return genLegacy($("#usage").val(), $("#pass").val(), $("#digit").val(), mode);
            } else {
                return genNormal($("#usage").val(), $("#pass").val(), $("#digit").val());
            }
        }
        $("#legacy").click(function() {
            if ($("#legacy").prop("checked")) {
                $("#legacy-detail-wrapper").removeAttr("hidden");
            } else {
                $("#legacy-detail-wrapper").attr("hidden", "true");
            }
        })
        $("#genAndCopy").click(function () {
            $("#res").val(gen());
            $("#resultDiv").removeAttr("hidden");
            $("#message").text("已复制到剪贴板");
            $("#res").select();
            document.execCommand("copy");
        })
        $("#gen").click(function () {
            $("#res").val(gen());
            $("#resultDiv").removeAttr("hidden");
            $("#message").text("");
        })
        $("#usage").keydown(e => {
            if(e.keyCode == 13) {
                $("#genAndCopy").click();
            }
        })
        $("#pass").keydown(e => {
            if(e.keyCode == 13) {
                $("#genAndCopy").click();
            }
        })
    </script>
</body>

</html>